{% extends 'layout.html' %}

{% block title %}Editar Plantilla de Correo Electrónico{% endblock %}

{% block styles %}
<!-- Estilos personalizados para el editor -->
<style>
    .email-editor-container {
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        margin-bottom: 1rem;
        background-color: #fff;
    }
    
    .email-editor-toolbar {
        display: flex;
        flex-wrap: wrap;
        border-bottom: 1px solid #ced4da;
        padding: 10px;
        background-color: #f8f9fa;
    }
    
    .toolbar-button {
        background: transparent;
        border: none;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #212529;
        cursor: pointer;
        margin-right: 5px;
        border-radius: 3px;
    }
    
    .toolbar-button:hover {
        background-color: #e9ecef;
    }
    
    .toolbar-button.active {
        background-color: #e9ecef;
    }
    
    .toolbar-select {
        background-color: #fff;
        border: 1px solid #ced4da;
        height: 36px;
        border-radius: 3px;
        padding: 0 8px;
        margin-right: 10px;
        font-size: 14px;
    }
    
    .toolbar-divider {
        width: 1px;
        background-color: #ced4da;
        height: 36px;
        margin: 0 10px;
    }
    
    .editor-content {
        padding: 15px;
        min-height: 300px;
        background-color: white;
    }
    
    [contenteditable="true"]:focus {
        outline: none;
    }
    
    .tag-badge {
        cursor: pointer;
        user-select: none;
        margin-right: 5px;
        margin-bottom: 5px;
    }
    
    .variables-container {
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        padding: 10px;
        margin-bottom: 1rem;
    }
    
    .highlighted-text {
        background-color: #ffff00;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('templates.index') }}">Plantillas de Mensajes</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('templates.email_templates') }}">Plantillas de Email</a></li>
                <li class="breadcrumb-item active">Editar Plantilla</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h3 mb-0">Editar Plantilla de Correo Electrónico</h1>
        <p class="text-muted">Modifica la plantilla "{{ template.name }}"</p>
    </div>
    <div class="col-md-4 text-md-end">
        <a href="{{ url_for('templates.preview_email_template', template_id=template.id) }}" target="_blank" class="btn btn-outline-info">
            <i class="fas fa-eye me-2"></i>Previsualizar
        </a>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="post">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="name" class="form-label">Nombre de la Plantilla <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="name" name="name" value="{{ template.name }}" required>
                    <div class="form-text">Nombre descriptivo para identificar esta plantilla</div>
                </div>
                <div class="col-md-6">
                    <label for="subject" class="form-label">Asunto del Correo <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="subject" name="subject" value="{{ template.subject }}" required>
                    <div class="form-text">Asunto que se mostrará en los correos enviados</div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="description" class="form-label">Descripción</label>
                <textarea class="form-control" id="description" name="description" rows="2">{{ template.description or '' }}</textarea>
                <div class="form-text">Descripción interna para identificar el propósito de esta plantilla</div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="sender_name" class="form-label">Nombre del Remitente</label>
                    <input type="text" class="form-control" id="sender_name" name="sender_name" value="{{ template.sender_name or '' }}">
                </div>
                <div class="col-md-6">
                    <label for="sender_email" class="form-label">Email del Remitente</label>
                    <input type="email" class="form-control" id="sender_email" name="sender_email" value="{{ template.sender_email or '' }}">
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Variables Disponibles</label>
                <div class="variables-container">
                    <p class="small mb-2">Haz clic en una variable para insertarla en el contenido del correo:</p>
                    <div>
                        <span class="badge bg-primary tag-badge" data-value="{{nombre}}">{{nombre}}</span>
                        <span class="badge bg-primary tag-badge" data-value="{{apellido}}">{{apellido}}</span>
                        <span class="badge bg-primary tag-badge" data-value="{{email}}">{{email}}</span>
                        <span class="badge bg-primary tag-badge" data-value="{{empresa}}">{{empresa}}</span>
                        <span class="badge bg-primary tag-badge" data-value="{{telefono}}">{{telefono}}</span>
                        <span class="badge bg-primary tag-badge" data-value="{{fecha}}">{{fecha}}</span>
                        <span class="badge bg-primary tag-badge" data-value="{{url_confirmacion}}">{{url_confirmacion}}</span>
                    </div>
                </div>
                <input type="hidden" id="available_variables" name="available_variables" value='{% if template.available_variables %}{{ template.available_variables|tojson }}{% else %}{"nombre":"Nombre del contacto","apellido":"Apellido del contacto","email":"Email del contacto","empresa":"Nombre de la empresa","telefono":"Teléfono del contacto","fecha":"Fecha actual","url_confirmacion":"URL de confirmación"}{% endif %}'>
            </div>
            
            <div class="mb-3">
                <label for="emailEditor" class="form-label">Contenido del Correo <span class="text-danger">*</span></label>
                
                <!-- Contenedor del editor de email -->
                <div class="email-editor-container">
                    <!-- Barra de herramientas simplificada -->
                    <div class="email-editor-toolbar">
                        <button type="button" class="toolbar-button" id="bold-btn" title="Negrita"><strong>B</strong></button>
                        <button type="button" class="toolbar-button" id="italic-btn" title="Cursiva"><em>I</em></button>
                        <button type="button" class="toolbar-button" id="underline-btn" title="Subrayado"><u>U</u></button>
                        
                        <select id="font-family" class="toolbar-select" style="width: 120px;">
                            <option value="Verdana">Verdana</option>
                            <option value="Arial">Arial</option>
                            <option value="Helvetica">Helvetica</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Courier New">Courier New</option>
                        </select>
                        
                        <select id="font-size" class="toolbar-select" style="width: 60px;">
                            <option value="2">10</option>
                            <option value="3">12</option>
                            <option value="4">14</option>
                            <option value="5">18</option>
                        </select>
                        
                        <div class="toolbar-divider"></div>
                        
                        <button type="button" class="toolbar-button" id="align-left" title="Alinear a la izquierda">
                            <i class="fas fa-align-left"></i>
                        </button>
                        <button type="button" class="toolbar-button" id="align-center" title="Centrar">
                            <i class="fas fa-align-center"></i>
                        </button>
                        <button type="button" class="toolbar-button" id="align-right" title="Alinear a la derecha">
                            <i class="fas fa-align-right"></i>
                        </button>
                        <button type="button" class="toolbar-button" id="align-justify" title="Justificar">
                            <i class="fas fa-align-justify"></i>
                        </button>
                        
                        <div class="toolbar-divider"></div>
                        
                        <button type="button" class="toolbar-button" id="insert-link" title="Insertar enlace">
                            <i class="fas fa-link"></i>
                        </button>
                        <button type="button" class="toolbar-button" id="insert-table" title="Insertar tabla">
                            <i class="fas fa-table"></i>
                        </button>
                        
                        <div class="toolbar-divider"></div>
                        
                        <button type="button" class="toolbar-button" id="bullet-list" title="Lista con viñetas">
                            <i class="fas fa-list-ul"></i>
                        </button>
                        <button type="button" class="toolbar-button" id="numbered-list" title="Lista numerada">
                            <i class="fas fa-list-ol"></i>
                        </button>
                    </div>
                    
                    <!-- Área editable del contenido -->
                    <div id="emailEditor" class="editor-content" contenteditable="true">{{ template.body_html|safe }}</div>
                </div>
                
                <!-- Campo oculto que guarda el HTML para enviar al servidor -->
                <input type="hidden" id="body_html" name="body_html" required>
                
                <div class="form-text">Contenido HTML del correo. Puedes utilizar las variables disponibles.</div>
            </div>
            
            <div class="mb-3">
                <label for="body_text" class="form-label">Versión de Texto Plano</label>
                <textarea class="form-control" id="body_text" name="body_text" rows="5">{{ template.body_text or '' }}</textarea>
                <div class="form-text">Versión alternativa en texto plano (sin formato) para clientes de correo que no soportan HTML.</div>
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="{{ url_for('templates.email_templates') }}" class="btn btn-outline-secondary">Cancelar</a>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Editor functions
        function execCommand(command, value = null) {
            document.execCommand(command, false, value);
            focusEditor();
        }
        
        function focusEditor() {
            document.getElementById('emailEditor').focus();
        }
        
        // Obtener selección actual
        function getSelectionRange() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                return selection.getRangeAt(0);
            }
            return null;
        }
        
        // Handlers para botones de formato básico
        $('#bold-btn').click(() => execCommand('bold'));
        $('#italic-btn').click(() => execCommand('italic'));
        $('#underline-btn').click(() => execCommand('underline'));
        
        // Handlers para alineación
        $('#align-left').click(() => execCommand('justifyLeft'));
        $('#align-center').click(() => execCommand('justifyCenter'));
        $('#align-right').click(() => execCommand('justifyRight'));
        $('#align-justify').click(() => execCommand('justifyFull'));
        
        // Handlers para listas
        $('#bullet-list').click(() => execCommand('insertUnorderedList'));
        $('#numbered-list').click(() => execCommand('insertOrderedList'));
        
        // Cambiar fuente
        $('#font-family').change(function() {
            execCommand('fontName', $(this).val());
        });
        
        // Cambiar tamaño de fuente
        $('#font-size').change(function() {
            execCommand('fontSize', $(this).val());
        });
        
        // Color de texto y fondo con selector de color
        $('#text-color').click(function() {
            const color = prompt('Ingrese el color en formato hexadecimal (ej: #FF0000 para rojo)', '#000000');
            if (color) {
                execCommand('foreColor', color);
            }
        });
        
        $('#bg-color').click(function() {
            const color = prompt('Ingrese el color en formato hexadecimal (ej: #FFFF00 para amarillo)', '#FFFF00');
            if (color) {
                execCommand('hiliteColor', color);
            }
        });
        
        // Insertar enlace
        $('#insert-link').click(function() {
            const url = prompt('Ingrese la URL del enlace:', 'https://');
            if (url) {
                execCommand('createLink', url);
            }
        });
        
        // Insertar imagen
        $('#insert-image').click(function() {
            const url = prompt('Ingrese la URL de la imagen:', 'https://');
            if (url) {
                execCommand('insertImage', url);
            }
        });
        
        // Insertar tabla simple
        $('#insert-table').click(function() {
            const rows = prompt('Número de filas:', '3');
            const cols = prompt('Número de columnas:', '3');
            
            if (rows && cols) {
                let tableHTML = '<table style="width:100%; border-collapse:collapse;">';
                
                for (let i = 0; i < parseInt(rows); i++) {
                    tableHTML += '<tr>';
                    for (let j = 0; j < parseInt(cols); j++) {
                        tableHTML += '<td style="border:1px solid #ced4da; padding:8px;">Celda</td>';
                    }
                    tableHTML += '</tr>';
                }
                
                tableHTML += '</table><br>';
                
                // Insertar la tabla usando el método de inserción de HTML
                document.execCommand('insertHTML', false, tableHTML);
            }
        });
        
        // Manejador para las etiquetas de variables
        $('.tag-badge').click(function() {
            const value = $(this).data('value');
            
            // Insertar el valor en la posición del cursor en el editor
            execCommand('insertText', value);
        });
        
        // Actualizar el campo oculto y generar texto plano al enviar el formulario
        $('form').submit(function(e) {
            // Guardar el contenido HTML en el campo oculto
            const htmlContent = $('#emailEditor').html();
            $('#body_html').val(htmlContent);
            
            // Generar versión de texto plano si no está definida
            if (!$('#body_text').val()) {
                // Conversión simple de HTML a texto
                let textContent = htmlContent.replace(/<[^>]+>/g, ' '); // Reemplazar etiquetas HTML por espacios
                textContent = textContent.replace(/\s+/g, ' '); // Reemplazar múltiples espacios por uno solo
                textContent = textContent.trim(); // Eliminar espacios al inicio y final
                
                // Establecer el contenido de texto plano
                $('#body_text').val(textContent);
            }
            
            return true;
        });
        
        // Enfoque inicial en el editor
        focusEditor();
    });
</script>
{% endblock %}