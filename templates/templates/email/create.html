{% extends 'layout.html' %}

{% block title %}Nueva Plantilla de Correo Electrónico{% endblock %}

{% block styles %}
<!-- Estilos personalizados para el editor -->
<style>
    .editor-toolbar {
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        border-radius: 0.25rem 0.25rem 0 0;
        padding: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 0;
    }
    
    .toolbar-group {
        display: flex;
        border-right: 1px solid #dee2e6;
        padding-right: 10px;
        margin-right: 10px;
    }
    
    .toolbar-group:last-child {
        border-right: none;
    }
    
    .editor-toolbar button {
        background: transparent;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 5px 10px;
        cursor: pointer;
        color: #495057;
    }
    
    .editor-toolbar button:hover {
        background-color: #e9ecef;
    }
    
    .editor-toolbar select {
        height: 37px;
        border-color: #dee2e6;
    }
    
    .editor-content {
        border: 1px solid #ced4da;
        border-top: none;
        border-radius: 0 0 0.25rem 0.25rem;
        padding: 15px;
        min-height: 300px;
        background-color: white;
    }
    
    .tag-badge {
        cursor: pointer;
        user-select: none;
        margin-right: 5px;
        margin-bottom: 5px;
    }
    
    .variables-container {
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        padding: 10px;
        margin-bottom: 1rem;
    }
    
    [contenteditable="true"]:focus {
        outline: none;
    }
    
    .highlight {
        background-color: #fff3cd;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('templates.index') }}">Plantillas de Mensajes</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('templates.email_templates') }}">Plantillas de Email</a></li>
                <li class="breadcrumb-item active">Nueva Plantilla</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-0">Nueva Plantilla de Correo Electrónico</h1>
        <p class="text-muted">Crea una nueva plantilla para envío de correos electrónicos</p>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="post">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="name" class="form-label">Nombre de la Plantilla <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="name" name="name" required>
                    <div class="form-text">Nombre descriptivo para identificar esta plantilla</div>
                </div>
                <div class="col-md-6">
                    <label for="subject" class="form-label">Asunto del Correo <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="subject" name="subject" required>
                    <div class="form-text">Asunto que se mostrará en los correos enviados</div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="description" class="form-label">Descripción</label>
                <textarea class="form-control" id="description" name="description" rows="2"></textarea>
                <div class="form-text">Descripción interna para identificar el propósito de esta plantilla</div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="sender_name" class="form-label">Nombre del Remitente</label>
                    <input type="text" class="form-control" id="sender_name" name="sender_name">
                </div>
                <div class="col-md-6">
                    <label for="sender_email" class="form-label">Email del Remitente</label>
                    <input type="email" class="form-control" id="sender_email" name="sender_email">
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Variables Disponibles</label>
                <div class="variables-container">
                    <p class="small mb-2">Haz clic en una variable para insertarla en el contenido del correo:</p>
                    <div>
                        <span class="badge bg-primary tag-badge" data-value="{{nombre}}">{{nombre}}</span>
                        <span class="badge bg-primary tag-badge" data-value="{{apellido}}">{{apellido}}</span>
                        <span class="badge bg-primary tag-badge" data-value="{{email}}">{{email}}</span>
                        <span class="badge bg-primary tag-badge" data-value="{{empresa}}">{{empresa}}</span>
                        <span class="badge bg-primary tag-badge" data-value="{{telefono}}">{{telefono}}</span>
                        <span class="badge bg-primary tag-badge" data-value="{{fecha}}">{{fecha}}</span>
                        <span class="badge bg-primary tag-badge" data-value="{{url_confirmacion}}">{{url_confirmacion}}</span>
                    </div>
                </div>
                <input type="hidden" id="available_variables" name="available_variables" value='{"nombre":"Nombre del contacto","apellido":"Apellido del contacto","email":"Email del contacto","empresa":"Nombre de la empresa","telefono":"Teléfono del contacto","fecha":"Fecha actual","url_confirmacion":"URL de confirmación"}'>
            </div>
            
            <div class="mb-3">
                <label for="emailEditor" class="form-label">Contenido del Correo <span class="text-danger">*</span></label>
                
                <!-- Barra de herramientas del editor -->
                <div class="editor-toolbar">
                    <div class="toolbar-group">
                        <button type="button" id="bold-btn" title="Negrita"><i class="fas fa-bold"></i></button>
                        <button type="button" id="italic-btn" title="Cursiva"><i class="fas fa-italic"></i></button>
                        <button type="button" id="underline-btn" title="Subrayado"><i class="fas fa-underline"></i></button>
                    </div>
                    
                    <div class="toolbar-group">
                        <select id="font-family" class="form-select form-select-sm me-2" style="width: 120px;">
                            <option value="Verdana">Verdana</option>
                            <option value="Arial">Arial</option>
                            <option value="Helvetica">Helvetica</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Courier New">Courier New</option>
                        </select>
                        
                        <select id="font-size" class="form-select form-select-sm" style="width: 60px;">
                            <option value="1">8</option>
                            <option value="2">10</option>
                            <option value="3">12</option>
                            <option value="4">14</option>
                            <option value="5">18</option>
                            <option value="6">24</option>
                            <option value="7">36</option>
                        </select>
                    </div>
                    
                    <div class="toolbar-group">
                        <button type="button" id="text-color" title="Color de texto"><i class="fas fa-palette"></i></button>
                        <button type="button" id="bg-color" title="Color de fondo"><i class="fas fa-fill-drip"></i></button>
                    </div>
                    
                    <div class="toolbar-group">
                        <button type="button" id="align-left" title="Alinear a la izquierda"><i class="fas fa-align-left"></i></button>
                        <button type="button" id="align-center" title="Centrar"><i class="fas fa-align-center"></i></button>
                        <button type="button" id="align-right" title="Alinear a la derecha"><i class="fas fa-align-right"></i></button>
                        <button type="button" id="align-justify" title="Justificar"><i class="fas fa-align-justify"></i></button>
                    </div>
                    
                    <div class="toolbar-group">
                        <button type="button" id="insert-link" title="Insertar enlace"><i class="fas fa-link"></i></button>
                        <button type="button" id="insert-table" title="Insertar tabla"><i class="fas fa-table"></i></button>
                        <button type="button" id="insert-image" title="Insertar imagen"><i class="fas fa-image"></i></button>
                    </div>
                    
                    <div class="toolbar-group">
                        <button type="button" id="bullet-list" title="Lista con viñetas"><i class="fas fa-list-ul"></i></button>
                        <button type="button" id="numbered-list" title="Lista numerada"><i class="fas fa-list-ol"></i></button>
                    </div>
                </div>
                
                <!-- Área editable del contenido -->
                <div id="emailEditor" class="editor-content" contenteditable="true">
                    <div>Bienvenido a Zylker!</div>
                    <div><br></div>
                    <div>Hola {{nombre}},</div>
                    <div><br></div>
                    <div>Su ID de visitante es <span style="background-color: #ffff00;">{{id_visitante}}</span></div>
                    <div><br></div>
                    <div>Visite nuestro sitio web para más información.</div>
                    <div><br></div>
                    <div>Saludos cordiales,</div>
                    <div>El equipo de Zylker</div>
                </div>
                
                <!-- Campo oculto que guarda el HTML para enviar al servidor -->
                <input type="hidden" id="body_html" name="body_html" required>
                
                <div class="form-text">Contenido HTML del correo. Puedes utilizar las variables disponibles.</div>
            </div>
            
            <div class="mb-3">
                <label for="body_text" class="form-label">Versión de Texto Plano</label>
                <textarea class="form-control" id="body_text" name="body_text" rows="5"></textarea>
                <div class="form-text">Versión alternativa en texto plano (sin formato) para clientes de correo que no soportan HTML.</div>
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="{{ url_for('templates.email_templates') }}" class="btn btn-outline-secondary">Cancelar</a>
                <button type="submit" class="btn btn-primary">Guardar Plantilla</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Editor functions
        function execCommand(command, value = null) {
            document.execCommand(command, false, value);
            focusEditor();
        }
        
        function focusEditor() {
            document.getElementById('emailEditor').focus();
        }
        
        // Obtener selección actual
        function getSelectionRange() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                return selection.getRangeAt(0);
            }
            return null;
        }
        
        // Handlers para botones de formato básico
        $('#bold-btn').click(() => execCommand('bold'));
        $('#italic-btn').click(() => execCommand('italic'));
        $('#underline-btn').click(() => execCommand('underline'));
        
        // Handlers para alineación
        $('#align-left').click(() => execCommand('justifyLeft'));
        $('#align-center').click(() => execCommand('justifyCenter'));
        $('#align-right').click(() => execCommand('justifyRight'));
        $('#align-justify').click(() => execCommand('justifyFull'));
        
        // Handlers para listas
        $('#bullet-list').click(() => execCommand('insertUnorderedList'));
        $('#numbered-list').click(() => execCommand('insertOrderedList'));
        
        // Cambiar fuente
        $('#font-family').change(function() {
            execCommand('fontName', $(this).val());
        });
        
        // Cambiar tamaño de fuente
        $('#font-size').change(function() {
            execCommand('fontSize', $(this).val());
        });
        
        // Color de texto y fondo con selector de color
        $('#text-color').click(function() {
            const color = prompt('Ingrese el color en formato hexadecimal (ej: #FF0000 para rojo)', '#000000');
            if (color) {
                execCommand('foreColor', color);
            }
        });
        
        $('#bg-color').click(function() {
            const color = prompt('Ingrese el color en formato hexadecimal (ej: #FFFF00 para amarillo)', '#FFFF00');
            if (color) {
                execCommand('hiliteColor', color);
            }
        });
        
        // Insertar enlace
        $('#insert-link').click(function() {
            const url = prompt('Ingrese la URL del enlace:', 'https://');
            if (url) {
                execCommand('createLink', url);
            }
        });
        
        // Insertar imagen
        $('#insert-image').click(function() {
            const url = prompt('Ingrese la URL de la imagen:', 'https://');
            if (url) {
                execCommand('insertImage', url);
            }
        });
        
        // Insertar tabla simple
        $('#insert-table').click(function() {
            const rows = prompt('Número de filas:', '3');
            const cols = prompt('Número de columnas:', '3');
            
            if (rows && cols) {
                let tableHTML = '<table style="width:100%; border-collapse:collapse;">';
                
                for (let i = 0; i < parseInt(rows); i++) {
                    tableHTML += '<tr>';
                    for (let j = 0; j < parseInt(cols); j++) {
                        tableHTML += '<td style="border:1px solid #ced4da; padding:8px;">Celda</td>';
                    }
                    tableHTML += '</tr>';
                }
                
                tableHTML += '</table><br>';
                
                // Insertar la tabla usando el método de inserción de HTML
                document.execCommand('insertHTML', false, tableHTML);
            }
        });
        
        // Manejador para las etiquetas de variables
        $('.tag-badge').click(function() {
            const value = $(this).data('value');
            
            // Insertar el valor en la posición del cursor en el editor
            execCommand('insertText', value);
        });
        
        // Actualizar el campo oculto y generar texto plano al enviar el formulario
        $('form').submit(function(e) {
            // Guardar el contenido HTML en el campo oculto
            const htmlContent = $('#emailEditor').html();
            $('#body_html').val(htmlContent);
            
            // Generar versión de texto plano si no está definida
            if (!$('#body_text').val()) {
                // Conversión simple de HTML a texto
                let textContent = htmlContent.replace(/<[^>]+>/g, ' '); // Reemplazar etiquetas HTML por espacios
                textContent = textContent.replace(/\s+/g, ' '); // Reemplazar múltiples espacios por uno solo
                textContent = textContent.trim(); // Eliminar espacios al inicio y final
                
                // Establecer el contenido de texto plano
                $('#body_text').val(textContent);
            }
            
            return true;
        });
        
        // Enfoque inicial en el editor
        focusEditor();
    });
</script>
{% endblock %}